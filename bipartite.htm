<html>
<head>
    <script src="lib/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="lib/d3.min.js" type="text/javascript"></script>
    <script src="lib/packages.js" type="text/javascript"></script>
    <script src="lib/biPartite.js" type="text/javascript"></script>
    <script src="lib/biPartite-plot.js" type="text/javascript"></script>
    <style>
        body {
            padding-top: 10px;
        }
    </style>
</head>
<body>

<div id="chtBiPartite"
     data-token="{{page.accessToken}}"
     data-apiUrl="{{apiUrl}}"
     data-postIds=" {{postIds}}"
     class="bipartite"></div>

</body>
<script type="text/javascript">
    var getData = (function () {
        return {
            sendReq: function (token, apiUrl) {
                var url = apiUrl + 'buildbipartite?token=%27' + token + '%27&source=facebook&post_ids=';
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (xhttp.readyState == 4 && xhttp.status == 200) {
                        console.log(xhttp.responseText);
                        var plot = new biPartitePlot("chtBiPartite");
                        plot.draw(xhttp.responseText);
                     }
                };
                xhttp.open("GET", url, true);
                xhttp.send();
            },
            isLoop: true
        }
    })();

    window.onload = function () {
        var isLoop = true;
        setInterval(function () {
            if (isLoop) {
                $('.bipartite').each(function () {
                    var token = this.getAttribute('data-token');
                    var apiUrl = this.getAttribute('data-apiUrl');
                    setTimeout(function () {
                        if (token.length != 0) {
                            getData.sendReq(token, apiUrl);
                            isLoop = false;
                        }
                    }, 200);
                });
            }
        }, 1000);
    };

</script>

</html>